---
- name: Install Kubernetes nodes
  hosts: all
  become: true


  vars:
    time_zone: "Europe/Budapest"

    system_services:
      - "chrony.service"

    packages_install_dnf:
      - bind-utils        # Debug DNS
      - net-tools         # Debug network, eg ping
      - nc                # Debug network, tcp
      - nmap              # Debug network, scan
      - ntpsec            # Debug NTP
      - jq                # JSON processing
      - pwgen             # Security: password generation
      - podman            # Podman engine
      - container-tools   # Buildah, Skopeo, CRIU (snapshot container state to disk), Udica (selinux policy generator for containers)


  tasks:
    - name: "Populate facts"
      ansible.builtin.service_facts:

    - name: "Set timezone"
      community.general.timezone:
        name: "{{ time_zone }}"


    - name: "Install packages"
      ansible.builtin.dnf:
        name: "{{ packages_install_dnf }}"
        state: present

    - name: "Enable and start services"
      ansible.builtin.service:
        name: "{{ item }}"
        enabled: true
        state: started
      with_items: "{{ system_services }}"

#     - name: "Set up host firewall"
#       import_role:
#         name: "linux-system-roles.firewall"
#       vars:
#         firewall:
#           - zone:    "external"
#             port:    "80/tcp"
#             state:   enabled
#
#           - zone:    "external"
#             port:    "443/tcp"
#             state:   enabled


  handlers:
    - name: "Reboot the machine"
      ansible.builtin.reboot:


    - name: "Restart systemd"
      ansible.builtin.systemd:
        daemon-reload: true

### TODO: https://gist.github.com/szpeter80/41dae240abad385e75b6abddf89e3ed2
